---
title: "Readmission or Death After First HF Discharge"
author: "Michail Giakoumis; Davit Sargsyan "
date: "05/11/2019"
output:
  html_notebook:
    highlight: tango
    number_sections: no
    theme: united
    toc: yes
    df_print: paged
---

# Header

```{r Header, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# |----------------------------------------------------------------------------------|
# | Project: Heart Failure Readmissions                                              |
# | Study ID: ?                                                                      |
# | Script: Data analysis                                                            |
# | Principal Investigator: John B. Kostis                                           |
# | Coordinator: Michail Giakoumis                                                   |
# | Statistician: Davit Sargsyan                                                     |   
# | Created:  05/11/2019                                                             |
# | Modified: 07/08/2017, kept inpatients only                                       |
# |----------------------------------------------------------------------------------|
# Header----
# Load packages
require(data.table)
require(DT)
require(ggplot2)
require(knitr)
```

# PART I: Data
```{r Data, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, include=TRUE}
load("data/case.RData")

# Number of patients
nrow(case)

# Make age per 10 year
case$decade <- floor(case$AGE/10)

# HF discharges----
t1 <- table(case$DSCYR)
t1 <- data.table(Year = as.integer(names(t1)),
                 Counts = c(t1))
DT::datatable(t1,
              caption = "Number of HF Discharges",
              rownames = FALSE,
              options = list(searching = TRUE,
                             pageLength = nrow(t1)))
```

```{r plotHF, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.height=5, fig.width=7}
# Plot HF discharges----
p0 <- ggplot(t1,
             aes(x = Year,
                 y = Counts)) +
  geom_line(size = 1) +
  geom_vline(xintercept = c(2000, 2014),
             linetype = "dashed") +
  geom_point(size = 3,
             shape = 21,
             fill = "red") +
  scale_x_continuous("Number of Patients",
                     breaks = 1995:2015,
                     limits = c(1995, 2015)) +
  scale_y_continuous(breaks = seq(0, 15000, 1000),
                     limits = c(0, 15000)) +
  ggtitle(paste("Number of First HF Discharges \n",
                "Total of",
                nrow(case),
                "Patients \n No Prior HF")) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        plot.title = element_text(hjust = 0.5))
p0
```

NOTE: the higher number in early years could be due to no information on prior HF, hence more patients remained. Also, we needed at least one year follow-up for all patients. Hence, we restricted records to 2000-2014 interval.

```{r demog, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
case <- case[YEAR > 1999 & case$DSCYR < 2015, ]

# Pubication/Table1: Demographics----
summary(case)

table1 <- t(data.table(`Mean Age at First AMI Admission +/- S.D.` = paste(round(mean(case$AGE), 1),
                                                                          "+/-",
                                                                          round(sd(case$AGE), 1),
                                                                          sep = ""),
                       `Female(%)` = round(100*sum(case$SEX == "F")/nrow(case), 
                                           1),
                       `Race(%)` = "",
                       `  White` = round(100*sum(case$RACE == "White")/nrow(case),
                                         1),
                       `  Black` = round(100*sum(case$RACE == "Black")/nrow(case),
                                         1),
                       `  Other` = round(100*sum(case$RACE == "Other")/nrow(case),
                                         1),
                       `Ethnicity(%)` = "",
                       `  Hispanic` = round(100*sum(case$HISPAN == "Hispanic")/nrow(case), 
                                            1),
                       `  Non-hispanic` = round(100*sum(case$HISPAN == "Non-Hispanic")/nrow(case), 
                                                1),
                       `  Unknown` = round(100*sum(case$HISPAN == "Unknown")/nrow(case), 
                                           1),
                       `Insurance(%)` = "",
                       `  Commercial` = round(100*sum(case$PRIME == "COMMERCIAL")/nrow(case), 
                                              1),
                       `  Medicare` = round(100*sum(case$PRIME == "medicare")/nrow(case), 
                                            1),
                       `  Medicaid/Self-Pay/Other` = round(100*sum(case$PRIME == "medicaid/self-pay/other")/nrow(case), 
                                                           1),
                       `Number of AMI Patients` = nrow(case)))
colnames(table1) <- "Summary"

# Save Table1 as CSV
write.csv(table1,
          file = "tmp/table1.csv")

DT::datatable(table1,
              caption = "AMI Patients Demographics",
              rownames = TRUE,
              options = list(searching = TRUE,
                             pageLength = nrow(table1)))
```

# PART II: Rates
```{r Rates, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.height=7, fig.width=8}
invisible({
  # Table 1a Appendix: all-cause readmissions----
  # 30 days----
  t1 <- addmargins(table(case$DSCYR,
                         case$days2readm < 31 &
                           !is.na(case$days2readm)))
  t1 <- data.table(dschyear = rownames(t1),
                   readm30 = t1[, 2],
                   N = t1[ , 3])
  t1[, rate := round(100*readm30/N, 2)]
  
  # 90 days----
  t2 <- addmargins(table(case$DSCYR,
                         case$days2readm < 91 &
                           !is.na(case$days2readm)))
  t2 <- data.table(dschyear = rownames(t2),
                   readm90 = t2[, 2],
                   N = t2[ , 3])
  t2[, rate := round(100*readm90/N, 2)]
  
  # 180 days----
  t3 <- addmargins(table(case$DSCYR,
                         case$days2readm < 181 &
                           !is.na(case$days2readm)))
  t3 <- data.table(dschyear = rownames(t3),
                   readm180 = t3[, 2],
                   N = t3[ , 3])
  t3[, rate := round(100*readm180/N, 2)]
  
  # 1 year----
  t4 <- addmargins(table(case$DSCYR,
                         case$days2readm < 366 &
                           !is.na(case$days2readm)))
  t4 <- data.table(dschyear = rownames(t4),
                   readm1y = t4[, 2],
                   N = t4[ , 3])
  t4[, rate := round(100*readm1y/N, 2)]
  
  # Combine----
  t1a.apx <- data.table(dschyear = t1$dschyear,
                        rate.30 = t1$rate,
                        rate.90 = t2$rate,
                        rate.180 = t3$rate,
                        rate.1y = t4$rate)
  
  # Table 1b Appendix: HF readmissions----
  # 30 days----
  t1 <- addmargins(table(case$DSCYR,
                         case$days2post.hf.dx1 < 31 &
                           !is.na(case$days2post.hf.dx1)))
  t1 <- data.table(dschyear = rownames(t1),
                   hf30 = t1[, 2],
                   N = t1[ , 3])
  t1[, rate := round(100*hf30/N, 2)]
  
  # 90 days----
  t2 <- addmargins(table(case$DSCYR,
                         case$days2post.hf.dx1 < 91 &
                           !is.na(case$days2post.hf.dx1)))
  t2 <- data.table(dschyear = rownames(t2),
                   hf90 = t2[, 2],
                   N = t2[ , 3])
  t2[, rate := round(100*hf90/N, 2)]
  
  # 180 days----
  t3 <- addmargins(table(case$DSCYR,
                         case$days2post.hf.dx1 < 181 &
                           !is.na(case$days2post.hf.dx1)))
  t3 <- data.table(dschyear = rownames(t3),
                   hf180 = t3[, 2],
                   N = t3[ , 3])
  t3[, rate := round(100*hf180/N, 2)]
  
  # 1 year----
  t4 <- addmargins(table(case$DSCYR,
                         case$days2post.hf.dx1 < 366 &
                           !is.na(case$days2post.hf.dx1)))
  t4 <- data.table(dschyear = rownames(t4),
                   hf1y = t4[, 2],
                   N = t4[ , 3])
  t4[, rate := round(100*hf1y/N, 2)]
  
  # Combine----
  t1b.apx <- data.table(dschyear = t1$dschyear,
                        rate.30 = t1$rate,
                        rate.90 = t2$rate,
                        rate.180 = t3$rate,
                        rate.1y = t4$rate)
  
  # Table 1c Appendix: all-cause death rates----
  # 30 days----
  t1 <- addmargins(table(case$DSCYR,
                         case$days2death < 31 &
                           !is.na(case$days2death)))
  t1 <- data.table(dschyear = rownames(t1),
                   death30 = t1[, 2],
                   N = t1[ , 3])
  t1[, rate := round(100*death30/N, 2)]
  
  # 90 days----
  t2 <- addmargins(table(case$DSCYR,
                         case$days2death < 91 &
                           !is.na(case$days2death)))
  t2 <- data.table(dschyear = rownames(t2),
                   death90 = t2[, 2],
                   N = t2[ , 3])
  t2[, rate := round(100*death90/N, 2)]
  
  # 180 days----
  t3 <- addmargins(table(case$DSCYR,
                         case$days2death < 181 &
                           !is.na(case$days2death)))
  t3 <- data.table(dschyear = rownames(t3),
                   death180 = t3[, 2],
                   N = t3[ , 3])
  t3[, rate := round(100*death180/N, 2)]
  
  # 1 year----
  t4 <- addmargins(table(case$DSCYR,
                         case$days2death < 366 &
                           !is.na(case$days2death)))
  t4 <- data.table(dschyear = rownames(t4),
                   death1y = t4[, 2],
                   N = t4[ , 3])
  t4[, rate := round(100*death1y/N, 2)]
  
  # Combine----
  t1c.apx <- data.table(dschyear = t1$dschyear,
                        rate.30 = t1$rate,
                        rate.90 = t2$rate,
                        rate.180 = t3$rate,
                        rate.1y = t4$rate)
  
  # Table 1d Appendix: CV death----
  # 30 days----
  t1 <- addmargins(table(case$DSCYR,
                         case$days2cvdeath < 31 &
                           !is.na(case$days2cvdeath)))
  t1 <- data.table(dschyear = rownames(t1),
                   cvdeath30 = t1[, 2],
                   N = t1[ , 3])
  t1[, rate := round(100*cvdeath30/N, 2)]
  
  # 90 days----
  t2 <- addmargins(table(case$DSCYR,
                         case$days2cvdeath < 91 &
                           !is.na(case$days2cvdeath)))
  t2 <- data.table(dschyear = rownames(t2),
                   cvdeath90 = t2[, 2],
                   N = t2[ , 3])
  t2[, rate := round(100*cvdeath90/N, 2)]
  
  # 180 days----
  t3 <- addmargins(table(case$DSCYR,
                         case$days2cvdeath < 181 &
                           !is.na(case$days2cvdeath)))
  t3 <- data.table(dschyear = rownames(t3),
                   cvdeath180 = t3[, 2],
                   N = t3[ , 3])
  t3[, rate := round(100*cvdeath180/N, 2)]
  
  # 1 year----
  t4 <- addmargins(table(case$DSCYR,
                         case$days2cvdeath < 366 &
                           !is.na(case$days2cvdeath)))
  t4 <- data.table(dschyear = rownames(t4),
                   cvdeath1y = t4[, 2],
                   N = t4[ , 3])
  t4[, rate := round(100*cvdeath1y/N, 2)]
  
  # Combine----
  t1d.apx <- data.table(dschyear = t1$dschyear,
                        rate.30 = t1$rate,
                        rate.90 = t2$rate,
                        rate.180 = t3$rate,
                        rate.1y = t4$rate)
})

# Print Table1 Appendix----
# Remove sums
t1a.apx <- t1a.apx[-nrow(t1a.apx)]
t1b.apx <- t1b.apx[-nrow(t1b.apx)]
t1c.apx <- t1c.apx[-nrow(t1c.apx)]
t1d.apx <- t1d.apx[-nrow(t1d.apx)]

# Save tables as a list
t1.apx <- list(t1a.apx,
               t1b.apx,
               t1c.apx,
               t1d.apx)
names(t1.apx) <- c("All-Cause Readmissions",
                   "HF Readmissions",
                   "All-Cause Mortality",
                   "Cardiovascular Mortality")

for(i in 1:length(t1.apx)) {
  tmp <- t1.apx[[i]]
  colnames(tmp) <- c("AMI Discharge Year",
                     "30-Day",
                     "90-Day",
                     "180-Day",
                     "1-Year")
  print(DT::datatable(tmp,
                      caption = names(t1.apx)[i],
                      rownames = FALSE,
                      options = list(searching = TRUE,
                                     pageLength = nrow(tmp))))
}

# Save Table1 Appendix as CSV
table1.apx <- cbind.data.frame(t1a.apx,
                               t1b.apx[, -1],
                               t1c.apx[, -1],
                               t1d.apx[, -1])
tmp <- data.frame(matrix(c("HF Discharge Year",
                           rep(c("30-Day",
                                 "90-Day",
                                 "180-Day",
                                 "1-Year"),
                               4)),
                         nrow = 1))
colnames(tmp) <- colnames(table1.apx)

table1.apx <- rbind.data.frame(tmp,
                               table1.apx)
colnames(table1.apx) <- c("",
                          "Rates of All-Cause Readmissions", "", "", "",
                          "Rates of HF Readmissions", "", "", "",
                          "Rates of All-Cause Death", "", "", "",
                          "Rates of CV Death", "", "", "")

write.csv(table1.apx,
          file = "tmp/table1.apx.csv",
          row.names = FALSE)

# Clean memory
invisible({
  rm(tmp)
  gc()
})

# Plot rates----
out <- list()
for (i in 1:length(t1.apx)) {
  out[[i]] <- melt.data.table(data = t1.apx[[i]], 
                              id.vars = "dschyear",
                              measure.vars = c(2:5),
                              variable.name = "followup",
                              value.name = "rate")
  out[[i]]$endpoint <- names(t1.apx)[[i]]
}

out <- do.call("rbind", out)

# Re-level follow-up
out$followup <- factor(out$followup,
                       levels = rev(levels(out$followup)))

# Endpoint as a factor
out$endpoint <- factor(out$endpoint,
                       levels = names(t1.apx))

# Figure 1: all rates----
p1 <- ggplot(data = out,
             aes(x = dschyear,
                 y = rate,
                 group = followup,
                 fill = followup)) +
  facet_wrap(~ endpoint,
             nrow = 2,
             scales = "free_y") +
  geom_line(size = 0.5) +
  geom_point(size = 2,
             shape = 21) +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  scale_x_discrete("1st HF Discharge Year",
                   breaks = unique(out$dschyear),
                   labels = unique(out$dschyear)) +
  scale_y_continuous("Rate (%)") +
  ggtitle("") +
  scale_fill_manual(label = c("1-Year",
                              "180-Day",
                              "90-Day",
                              "30-Day"),
                    values = unique(out$followup)) +
  guides(fill = guide_legend(title = "Follow-up")) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90,
                                   hjust = 0),
        plot.title = element_text(hjust = 0))

# # Save Figure1 as TIFF
# tiff(filename = "figure1_rates.tiff",
#      height = 5,
#      width = 12,
#      units = 'in',
#      res = 300,
#      compression = "lzw+p")
# print(p1)
# graphics.off()

# Print Figure1
p1
```
## Top Causes for Readmission
```{r readmCauses}
# load("data/icd9cm_pcs_billable.RData")
# dt.icd <- icd9cm_pcs_billable$`32`
source("source/icd9_dx_get_data_v1.R")
dt.icd <- icd9cm_merge_version_dx(32)

# NOTE: rerun data script and add DX1 for readmissions!!!
```

# PART III: Logistic Regression Models
```{r glmLabels}
t2.names <- c("Discharge year",
                 "Age (per 10 Years)",
                 "Sex (Male)",
                 "Non-Hispanic vs. Hispanic",
                 "Unknown vs. Hispanic",
                 "Commercial Insurance vs. Medicare",
                 "Medicaid/Self-Pay/Other vs. Medicare",
                 "AFib/AFlutter",
                 "AMI",
                 "Anemia",
                 "CKD",
                 "COPD",
                 "Diabetes",
                 "Hypertension",
                 "Hyperlipidemia",
                 "Sleep Apnea",
                 "Parkinson",
                 "Stroke",
                 "TIA")

case$DSCYR <- as.numeric(case$DSCYR)
```

## All-Cause Readmissions
```{r glmAllReadm, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.height=5, fig.width=9}
# Publication/Table 2a: All-cause readmissions----
case$readm30 <- case$readm90 <- case$readm180 <- case$readm1y <- FALSE
case$readm30[case$days2readm < 31] <- TRUE
case$readm90[case$days2readm < 91] <- TRUE
case$readm180[case$days2readm < 181] <- TRUE
case$readm1y[case$days2readm < 366] <- TRUE

m2a.30 <- glm(readm30 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2a.90 <- glm(readm90 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2a.180 <- glm(readm180 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
               family = binomial(logit),
               data = case)

m2a.1y <- glm(readm1y ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

# Combine
s2a <- list(summary(m2a.30),
            summary(m2a.90),
            summary(m2a.180),
            summary(m2a.1y))

t2a <- lapply(s2a, function(a) {
  out <- data.table(names = t2.names,
                    coef = exp(a$coefficients[-1, 1]),
                    lb = exp(a$coefficients[-1, 1] - 1.96*a$coefficients[-1, 2]),
                    ub = exp(a$coefficients[-1, 1] + 1.96*a$coefficients[-1, 2]),
                    pval = ifelse(a$coefficients[-1, 4] >= 0.001,
                                  round(a$coefficients[-1, 4], 3),
                                  "<0.001"),
                    sign = ifelse(a$coefficients[-1, 4] <= 0.05,
                                  ifelse(a$coefficients[-1, 4] <= 0.01,
                                         "**",
                                         "*"), ""))
  rownames(out) <- NULL
  return(out)
})

t2a <- do.call("rbind", t2a)

t2a <- data.table(followup = rep(c("30-Day",
                                   "90-Day",
                                   "180-Day",
                                   "1-Year"),
                                 each = length(t2.names)),
                  t2a)
t2a$names <- factor(t2a$names,
                    levels = unique(t2a$names))
t2a$followup <- factor(as.character(t2a$followup),
                       levels = c("30-Day",
                                  "90-Day",
                                  "180-Day",
                                  "1-Year"))

# Save Table 2A as CSV
t2a$est <- paste(round(t2a$coef, 3),
                 " (",
                 round(t2a$lb, 3),
                 ", ",
                 round(t2a$ub, 3),
                 ")\n",
                 t2a$pval,
                 sep = "")
table2a <- dcast.data.table(data = t2a,
                            names ~ followup,
                            value.var = "est")
colnames(table2a)[1] <- "Risk Factor"

write.csv(table2a,
          file = "tmp/table2a.csv",
          row.names = FALSE)

DT::datatable(table2a,
              caption = "Table2A: All-Cause Readmissions",
              rownames = FALSE,
              options = list(searching = TRUE,
                             pageLength = nrow(table2a)))

# Plot OR----
p2a <- ggplot(t2a,
              aes(x = names,
                  y = coef)) +
  facet_wrap( ~ followup,
              ncol = 2) +
  geom_hline(yintercept = 1,
             colour = "grey",
             size = 1.1,
             linetype = 2) +
  geom_errorbar(aes(ymin = lb,
                    ymax = ub),
                size = 0.4,
                width = 0.2) +
  geom_point(aes(x = names,
                 y = coef,
                 fill = names),
             size = 2,
             shape = 21) +
  scale_fill_manual(labels = paste(LETTERS[1:nlevels(t2a$names)],
                                   levels(t2a$names),
                                   sep = ": "),
                    values = rainbow(nlevels(t2a$names))) +
  scale_x_discrete("Risk Factors",
                   labels = LETTERS[1:nlevels(t2a$names)]) +
  scale_y_continuous("Odds Ratios") +
  ggtitle("Odds Ratios of All-Cause Readmissions") +
  theme(axis.text.x = element_text(size = 12,
                                   hjust = 1),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5)) +
  guides(fill = guide_legend("Risk Factors Legend"))

# # Save Figure2A as TIFF
# tiff(filename = "tmp/figure2a_all_readm_or.tiff",
#      height = 5,
#      width = 11,
#      units = 'in',
#      res = 300,
#      compression = "lzw+p")
# print(p2a)
# graphics.off()

p2a
```

## HF Cause Readmissions
```{r glmHFReadm, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.height=5, fig.width=9}
# Publication/Table 2a: All-cause readmissions----
case$hf30 <- case$hf90 <- case$hf180 <- case$hf1y <- FALSE
case$hf30[case$days2post.hf.dx1 < 31] <- TRUE
case$hf90[case$days2post.hf.dx1 < 91] <- TRUE
case$hf180[case$days2post.hf.dx1 < 181] <- TRUE
case$hf1y[case$days2post.hf.dx1 < 366] <- TRUE

m2b.30 <- glm(hf30 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2b.90 <- glm(hf90 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2b.180 <- glm(hf180 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
               family = binomial(logit),
               data = case)

m2b.1y <- glm(hf1y ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

# Combine
s2b <- list(summary(m2b.30),
            summary(m2b.90),
            summary(m2b.180),
            summary(m2b.1y))

t2b <- lapply(s2b, function(a) {
  out <- data.table(names = t2.names,
                    coef = exp(a$coefficients[-1, 1]),
                    lb = exp(a$coefficients[-1, 1] - 1.96*a$coefficients[-1, 2]),
                    ub = exp(a$coefficients[-1, 1] + 1.96*a$coefficients[-1, 2]),
                    pval = ifelse(a$coefficients[-1, 4] >= 0.001,
                                  round(a$coefficients[-1, 4], 3),
                                  "<0.001"),
                    sign = ifelse(a$coefficients[-1, 4] <= 0.05,
                                  ifelse(a$coefficients[-1, 4] <= 0.01,
                                         "**",
                                         "*"), ""))
  rownames(out) <- NULL
  return(out)
})

t2b <- do.call("rbind", t2b)

t2b <- data.table(followup = rep(c("30-Day",
                                   "90-Day",
                                   "180-Day",
                                   "1-Year"),
                                 each = length(t2.names)),
                  t2b)
t2b$names <- factor(t2b$names,
                    levels = unique(t2b$names))
t2b$followup <- factor(as.character(t2b$followup),
                       levels = c("30-Day",
                                  "90-Day",
                                  "180-Day",
                                  "1-Year"))

# Save Table 2A as CSV
t2b$est <- paste(round(t2b$coef, 3),
                 " (",
                 round(t2b$lb, 3),
                 ", ",
                 round(t2b$ub, 3),
                 ")\n",
                 t2b$pval,
                 sep = "")
table2b <- dcast.data.table(data = t2b,
                            names ~ followup,
                            value.var = "est")
colnames(table2b)[1] <- "Risk Factor"

write.csv(table2b,
          file = "tmp/table2b.csv",
          row.names = FALSE)

DT::datatable(table2b,
              caption = "Table2B: All-Cause Readmissions",
              rownames = FALSE,
              options = list(searching = TRUE,
                             pageLength = nrow(table2b)))

# Plot OR----
p2b <- ggplot(t2b,
              aes(x = names,
                  y = coef)) +
  facet_wrap( ~ followup,
              ncol = 2) +
  geom_hline(yintercept = 1,
             colour = "grey",
             size = 1.1,
             linetype = 2) +
  geom_errorbar(aes(ymin = lb,
                    ymax = ub),
                size = 0.4,
                width = 0.2) +
  geom_point(aes(x = names,
                 y = coef,
                 fill = names),
             size = 2,
             shape = 21) +
  scale_fill_manual(labels = paste(LETTERS[1:nlevels(t2a$names)],
                                   levels(t2a$names),
                                   sep = ": "),
                    values = rainbow(nlevels(t2a$names))) +
  scale_x_discrete("Risk Factors",
                   labels = LETTERS[1:nlevels(t2a$names)]) +
  scale_y_continuous("Odds Ratios") +
  ggtitle("Odds Ratios of HF Readmissions") +
  theme(axis.text.x = element_text(size = 12,
                                   hjust = 1),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5)) +
  guides(fill = guide_legend("Risk Factors Legend"))

# # Save Figure2B as TIFF
# tiff(filename = "tmp/figure2b_hf_readm_or.tiff",
#      height = 5,
#      width = 11,
#      units = 'in',
#      res = 300,
#      compression = "lzw+p")
# print(p2b)
# graphics.off()

p2b
```

## All-Cause Death
```{r glmAllCauseDeath, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.height=5, fig.width=9}
# Publication/Table 2c: All-cause death----
case$dead30 <- case$dead90 <- case$dead180 <- case$dead1y <- FALSE
case$dead30[case$days2death < 31] <- TRUE
case$dead90[case$days2death < 91] <- TRUE
case$dead180[case$days2death < 181] <- TRUE
case$dead1y[case$days2death < 366] <- TRUE

m2c.30 <- glm(dead30 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2c.90 <- glm(dead90 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2c.180 <- glm(dead180 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
               family = binomial(logit),
               data = case)

m2c.1y <- glm(dead1y ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

# Combine
s2c <- list(summary(m2c.30),
            summary(m2c.90),
            summary(m2c.180),
            summary(m2c.1y))

t2c <- lapply(s2c, function(a) {
  out <- data.table(names = t2.names,
                    coef = exp(a$coefficients[-1, 1]),
                    lb = exp(a$coefficients[-1, 1] - 1.96*a$coefficients[-1, 2]),
                    ub = exp(a$coefficients[-1, 1] + 1.96*a$coefficients[-1, 2]),
                    pval = ifelse(a$coefficients[-1, 4] >= 0.001,
                                  round(a$coefficients[-1, 4], 3),
                                  "<0.001"),
                    sign = ifelse(a$coefficients[-1, 4] <= 0.05,
                                  ifelse(a$coefficients[-1, 4] <= 0.01,
                                         "**",
                                         "*"), ""))
  rownames(out) <- NULL
  return(out)
})

t2c <- do.call("rbind", t2c)

t2c <- data.table(followup = rep(c("30-Day",
                                   "90-Day",
                                   "180-Day",
                                   "1-Year"),
                                 each = length(t2.names)),
                  t2c)
t2c$names <- factor(t2a$names,
                    levels = unique(t2c$names))
t2c$followup <- factor(as.character(t2c$followup),
                       levels = c("30-Day",
                                  "90-Day",
                                  "180-Day",
                                  "1-Year"))

# Save Table 2C as CSV
t2c$est <- paste(round(t2c$coef, 3),
                 " (",
                 round(t2c$lb, 3),
                 ", ",
                 round(t2c$ub, 3),
                 ")\n",
                 t2c$pval,
                 sep = "")
table2c <- dcast.data.table(data = t2c,
                            names ~ followup,
                            value.var = "est")
colnames(table2c)[1] <- "Risk Factor"

write.csv(table2c,
          file = "tmp/table2c.csv",
          row.names = FALSE)

DT::datatable(table2c,
              caption = "Table2C: All-Cause Death",
              rownames = FALSE,
              options = list(searching = TRUE,
                             pageLength = nrow(table2c)))

# Plot OR----
p2c <- ggplot(t2c,
              aes(x = names,
                  y = coef)) +
  facet_wrap( ~ followup,
              ncol = 2) +
  geom_hline(yintercept = 1,
             colour = "grey",
             size = 1.1,
             linetype = 2) +
  geom_errorbar(aes(ymin = lb,
                    ymax = ub),
                size = 0.4,
                width = 0.2) +
  geom_point(aes(x = names,
                 y = coef,
                 fill = names),
             size = 2,
             shape = 21) +
  scale_fill_manual(labels = paste(LETTERS[1:nlevels(t2c$names)],
                                   levels(t2c$names),
                                   sep = ": "),
                    values = rainbow(nlevels(t2c$names))) +
  scale_x_discrete("Risk Factors",
                   labels = LETTERS[1:nlevels(t2c$names)]) +
  scale_y_continuous("Odds Ratios") +
  ggtitle("Odds Ratios of All-Cause Death") +
  theme(axis.text.x = element_text(size = 12,
                                   hjust = 1),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5)) +
  guides(fill = guide_legend("Risk Factors Legend"))

# # Save Figure2C as TIFF
# tiff(filename = "tmp/figure2c_all_death_or.tiff",
#      height = 5,
#      width = 11,
#      units = 'in',
#      res = 300,
#      compression = "lzw+p")
# print(p2c)
# graphics.off()

p2c
```

## CV Death
```{r glmCVdeath, echo=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.height=5, fig.width=9}
# Publication/Table 2d: All-cause readmissions----
case$cvdeath30 <- case$cvdeath90 <- case$cvdeath180 <- case$cvdeath1y <- FALSE
case$cvdeath30[case$days2cvdeath < 31] <- TRUE
case$cvdeath90[case$days2cvdeath < 91] <- TRUE
case$cvdeath180[case$days2cvdeath < 181] <- TRUE
case$cvdeath1y[case$days2cvdeath < 366] <- TRUE

m2d.30 <- glm(cvdeath30 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2d.90 <- glm(cvdeath90 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

m2d.180 <- glm(cvdeath180 ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
               family = binomial(logit),
               data = case)

m2d.1y <- glm(cvdeath1y ~ DSCYR +
                decade +
                SEX +
                HISPAN +
                PRIME +
                haf +
                hami +
                hanemia  +
                hckd +
                hcopd +
                hdiab +
                hhyper +
                hlipid  +
                hosa +
                hpark +
                hstroke  +
                htia,
              family = binomial(logit),
              data = case)

# Combine
s2d <- list(summary(m2d.30),
            summary(m2d.90),
            summary(m2d.180),
            summary(m2d.1y))

t2d <- lapply(s2d, function(a) {
  out <- data.table(names = t2.names,
                    coef = exp(a$coefficients[-1, 1]),
                    lb = exp(a$coefficients[-1, 1] - 1.96*a$coefficients[-1, 2]),
                    ub = exp(a$coefficients[-1, 1] + 1.96*a$coefficients[-1, 2]),
                    pval = ifelse(a$coefficients[-1, 4] >= 0.001,
                                  round(a$coefficients[-1, 4], 3),
                                  "<0.001"),
                    sign = ifelse(a$coefficients[-1, 4] <= 0.05,
                                  ifelse(a$coefficients[-1, 4] <= 0.01,
                                         "**",
                                         "*"), ""))
  rownames(out) <- NULL
  return(out)
})

t2d <- do.call("rbind", t2d)

t2d <- data.table(followup = rep(c("30-Day",
                                   "90-Day",
                                   "180-Day",
                                   "1-Year"),
                                 each = length(t2.names)),
                  t2d)
t2d$names <- factor(t2d$names,
                    levels = unique(t2d$names))
t2d$followup <- factor(as.character(t2d$followup),
                       levels = c("30-Day",
                                  "90-Day",
                                  "180-Day",
                                  "1-Year"))

# Save Table 2D as CSV
t2d$est <- paste(round(t2d$coef, 3),
                 " (",
                 round(t2d$lb, 3),
                 ", ",
                 round(t2d$ub, 3),
                 ")\n",
                 t2d$pval,
                 sep = "")
table2d <- dcast.data.table(data = t2d,
                            names ~ followup,
                            value.var = "est")
colnames(table2d)[1] <- "Risk Factor"

write.csv(table2d,
          file = "tmp/table2d.csv",
          row.names = FALSE)

DT::datatable(table2d,
              caption = "Table2D: CV Death",
              rownames = FALSE,
              options = list(searching = TRUE,
                             pageLength = nrow(table2d)))

# Plot OR----
p2d <- ggplot(t2d,
              aes(x = names,
                  y = coef)) +
  facet_wrap( ~ followup,
              ncol = 2) +
  geom_hline(yintercept = 1,
             colour = "grey",
             size = 1.1,
             linetype = 2) +
  geom_errorbar(aes(ymin = lb,
                    ymax = ub),
                size = 0.4,
                width = 0.2) +
  geom_point(aes(x = names,
                 y = coef,
                 fill = names),
             size = 2,
             shape = 21) +
  scale_fill_manual(labels = paste(LETTERS[1:nlevels(t2a$names)],
                                   levels(t2a$names),
                                   sep = ": "),
                    values = rainbow(nlevels(t2a$names))) +
  scale_x_discrete("Risk Factors",
                   labels = LETTERS[1:nlevels(t2a$names)]) +
  scale_y_continuous("Odds Ratios") +
  ggtitle("Odds Ratios of CV Death") +
  theme(axis.text.x = element_text(size = 12,
                                   hjust = 1),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5)) +
  guides(fill = guide_legend("Risk Factors Legend"))

# # Save Figure2D as TIFF
# tiff(filename = "tmp/figure2d_cv_death_or.tiff",
#      height = 5,
#      width = 11,
#      units = 'in',
#      res = 300,
#      compression = "lzw+p")
# print(p2d)
# graphics.off()

p2d
```